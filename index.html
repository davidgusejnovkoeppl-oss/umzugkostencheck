<script>
  const TOTAL_STEPS = 5;
  // Laravel-Backend auf gleichem Host (127.0.0.1:8000)
  const API_URL = "/api/leads";

  let currentStep = 1;
  const formData = {};
  let todayStr = null;

  const stepEls = document.querySelectorAll(".form-step");
  const indicatorItems = document.querySelectorAll("#stepIndicator .step-item");
  const btnBack = document.getElementById("btnBack");
  const btnNext = document.getElementById("btnNext");
  const navRow = document.getElementById("navRow");

  const loadingBox = document.getElementById("matchingLoading");
  const resultBox = document.getElementById("matchingResult");

  function initDatesMin() {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    todayStr = today.toISOString().split("T")[0];
    ["move_date", "move_date_from", "move_date_to"].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.min = todayStr;
    });
  }

  function showStep(step) {
    currentStep = step;
    stepEls.forEach(el => {
      el.classList.toggle("active", Number(el.dataset.step) === step);
    });

    indicatorItems.forEach(item => {
      const s = Number(item.dataset.step);
      item.classList.toggle("current", s === step);
      item.classList.toggle("completed", s < step);
    });

    btnBack.disabled = (step === 1);

    if (step === 4) {
      btnNext.style.display = "none";
      runMatchingAnimation();
    } else {
      btnNext.style.display = "inline-flex";
    }

    navRow.style.display = (step === 6) ? "none" : "flex";
    btnNext.textContent = (step === 5) ? "Angebote erhalten" : "Weiter";

    validateStep();
  }

  function collectData() {
    formData.move_from_zip = document.getElementById("move_from_zip").value.trim();
    formData.move_from_city = document.getElementById("move_from_city").value.trim();
    formData.move_to_zip = document.getElementById("move_to_zip").value.trim();
    formData.move_to_city = document.getElementById("move_to_city").value.trim();

    formData.living_space_from = document.getElementById("living_space_from").value;
    formData.rooms_from = document.getElementById("rooms_from").value;
    formData.floor_from = document.getElementById("floor_from").value;
    formData.has_elevator_from = document.getElementById("has_elevator_from").checked;

    formData.living_space_to = document.getElementById("living_space_to").value;
    formData.rooms_to = document.getElementById("rooms_to").value;
    formData.floor_to = document.getElementById("floor_to").value;
    formData.has_elevator_to = document.getElementById("has_elevator_to").checked;

    formData.move_notes = document.getElementById("move_notes").value.trim();

    formData.customer_name = document.getElementById("customer_name").value.trim();
    formData.phone = document.getElementById("phone").value.trim();
    formData.email = document.getElementById("email").value.trim();

    formData.move_date_type = document.getElementById("move_date_type").value;
    formData.move_date = document.getElementById("move_date").value;
    formData.move_date_from = document.getElementById("move_date_from").value;
    formData.move_date_to = document.getElementById("move_date_to").value;

    const verifyInput = document.getElementById("verify_code");
    formData.verify_code = verifyInput ? verifyInput.value.trim() : "";

    // aus Step 3: move_type, is_international, move_scope
    // die werden direkt in formData gesetzt, siehe Choice Cards unten
  }

  function clearErrors() {
    document.querySelectorAll(".error").forEach(e => (e.textContent = ""));
  }

  function validateStep() {
    clearErrors();
    collectData();
    let valid = true;

    if (currentStep === 1) {
      if (!formData.move_from_zip) {
        document.getElementById("err_from_zip").textContent = "Bitte Postleitzahl eingeben.";
        valid = false;
      }
      if (!formData.move_to_zip) {
        document.getElementById("err_to_zip").textContent = "Bitte Postleitzahl eingeben.";
        valid = false;
      }
    }

    if (currentStep === 3) {
      if (!formData.move_type ||
          typeof formData.is_international === "undefined" ||
          !formData.move_scope) {
        document.getElementById("err_step3").textContent =
          "Bitte w√§hlen Sie jeweils eine Option aus allen Bereichen.";
        valid = false;
      }
    }

    if (currentStep === 5) {
      if (!formData.customer_name) {
        document.getElementById("err_name").textContent = "Bitte Namen eingeben.";
        valid = false;
      }
      if (!formData.phone) {
        document.getElementById("err_phone").textContent = "Bitte Telefonnummer eingeben.";
        valid = false;
      }
      if (!formData.email) {
        document.getElementById("err_email").textContent = "Bitte E-Mail eingeben.";
        valid = false;
      }

      let hasDate = false;

      if (formData.move_date_type === "fest") {
        hasDate = !!formData.move_date;
      } else {
        hasDate =
          !!formData.move_date_from &&
          !!formData.move_date_to &&
          formData.move_date_from <= formData.move_date_to;
      }

      if (!hasDate) {
        document.getElementById("err_date").textContent =
          "Bitte g√ºltigen Umzugstermin angeben.";
        valid = false;
      }
    }

    if (currentStep !== 4) btnNext.disabled = !valid;
    return valid;
  }

  // Choice Cards (Step 3)
  document.querySelectorAll(".choice-card").forEach(card => {
    card.addEventListener("click", () => {
      const group = card.dataset.choiceGroup;
      const value = card.dataset.choiceValue;

      document
        .querySelectorAll(`.choice-card[data-choice-group="${group}"]`)
        .forEach(c => c.classList.remove("selected"));

      card.classList.add("selected");

      if (group === "is_international") {
        formData.is_international = (value === "true");
      } else {
        formData[group] = value;
      }

      validateStep();
    });
  });

  // Datumswechsel Step 5
  const dateTypeSelect = document.getElementById("move_date_type");
  const dateFixed = document.getElementById("date_fixed");
  const dateRange = document.getElementById("date_range");

  dateTypeSelect.addEventListener("change", () => {
    if (dateTypeSelect.value === "fest") {
      dateFixed.style.display = "block";
      dateRange.style.display = "none";
    } else {
      dateFixed.style.display = "none";
      dateRange.style.display = "block";
    }
    validateStep();
  });

  // Live-Validierung
  document.querySelectorAll("input,select,textarea").forEach(el => {
    el.addEventListener("input", () => {
      if (currentStep === 1 || currentStep === 5) {
        validateStep();
      }
    });
  });

  // Zur√ºck-Button
  btnBack.addEventListener("click", () => {
    if (currentStep > 1) showStep(currentStep - 1);
  });

  // Payload genau passend zu LandingLeadController::store()
  function buildPayloadForApi() {
    return {
      move_from_zip: formData.move_from_zip || null,
      move_from_city: formData.move_from_city || null,
      move_to_zip: formData.move_to_zip || null,
      move_to_city: formData.move_to_city || null,

      living_space_from: formData.living_space_from || null,
      rooms_from: formData.rooms_from || null,
      floor_from: formData.floor_from || null,
      has_elevator_from: formData.has_elevator_from ? 1 : 0,

      living_space_to: formData.living_space_to || null,
      rooms_to: formData.rooms_to || null,
      floor_to: formData.floor_to || null,
      has_elevator_to: formData.has_elevator_to ? 1 : 0,

      move_notes: formData.move_notes || null,
      move_type: formData.move_type || null,
      is_international:
        typeof formData.is_international === "boolean"
          ? formData.is_international
          : null,
      move_scope: formData.move_scope || null,

      customer_name: formData.customer_name || null,
      phone: formData.phone || null,
      email: formData.email || null,

      move_date_type: formData.move_date_type || null,
      move_date: formData.move_date || null,
      move_date_from: formData.move_date_from || null,
      move_date_to: formData.move_date_to || null,

      verify_code: formData.verify_code || null,
    };
  }

  // Weiter / Absenden
  btnNext.addEventListener("click", async () => {
    if (!validateStep()) return;

    // Zwischen-Schritte
    if (currentStep < TOTAL_STEPS) {
      showStep(currentStep + 1);
      return;
    }

    // Letzter Schritt ‚Üí API Call
    collectData();
    const payload = buildPayloadForApi();
    console.log("üì¶ Payload an API:", payload);

    btnNext.disabled = true;
    btnNext.textContent = "Senden‚Ä¶";
    btnBack.disabled = true;

    try {
      const response = await fetch(API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify(payload)
      });

      const result = await response.json().catch(() => ({}));
      console.log("Antwort:", response.status, result);

      if (!response.ok) {
        alert(
          result.message ||
          "Es ist ein Fehler bei der √úbermittlung Ihrer Anfrage aufgetreten. Bitte pr√ºfen Sie Ihre Eingaben."
        );
        btnNext.disabled = false;
        btnBack.disabled = false;
        btnNext.textContent = "Angebote erhalten";
        return;
      }

      // Erfolg ‚Üí Danke-Schritt
      document.querySelector("main.card").scrollIntoView({ behavior: "smooth" });
      showStep(6);

    } catch (err) {
      console.error("Verbindungsfehler:", err);
      alert("Es ist ein Verbindungsfehler aufgetreten. Bitte sp√§ter erneut versuchen.");
      btnNext.disabled = false;
      btnBack.disabled = false;
      btnNext.textContent = "Angebote erhalten";
    }
  });

  function runMatchingAnimation() {
    if (!loadingBox || !resultBox) return;

    loadingBox.style.display = "block";
    resultBox.style.display = "none";

    setTimeout(() => {
      loadingBox.style.display = "none";
      resultBox.style.display = "block";
    }, 2000);

    setTimeout(() => {
      if (currentStep === 4) showStep(5);
    }, 4000);
  }

  initDatesMin();
  validateStep();
</script>
